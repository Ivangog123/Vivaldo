<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Sistema Inteligente de Pr√©-Diagn√≥stico - Assistente M√©dico Virtual">
    <meta name="keywords" content="sa√∫de, diagn√≥stico, m√©dico virtual, sintomas, assistente m√©dico">
    <title>Sistema Inteligente de Pr√©-Diagn√≥stico</title>

    <!-- √çcone do site -->
    <link rel="icon" type="image/png" href="./assets/images/icone.png" sizes="512x512">
    <link rel="apple-touch-icon" href="./assets/images/icone.png">
    
    <!-- Bibliotecas externas -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@0.263.0"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
    
    <!-- Estilos personalizados -->
    <style>
        :root {
            --primary-color: #0d9488;
            --secondary-color: #0f766e;
            --warning-color: #ca8a04;
            --danger-color: #dc2626;
            --success-color: #059669;
        }

        html, body {
            height: 100%;
            overflow: hidden;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #374151;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        #root {
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Custom Scrollbar */
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Anima√ß√µes */
        .typing-dot {
            animation: typing 1.4s infinite ease-in-out both;
        }
        
        .typing-dot:nth-child(1) { 
            animation-delay: -0.32s; 
        }
        
        .typing-dot:nth-child(2) { 
            animation-delay: -0.16s; 
        }
        
        @keyframes typing {
            0%, 80%, 100% { 
                transform: scale(0); 
            }
            
            40% { 
                transform: scale(1); 
            }
        }

        @keyframes fadeIn {
            from { 
                opacity: 0; 
                transform: translateY(10px); 
            }
            
            to { 
                opacity: 1; 
                transform: translateY(0); 
            }
        }
        
        .animate-fade-in {
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeOut {
            from { 
                opacity: 1; 
                transform: translateY(0); 
            }
            
            to { 
                opacity: 0; 
                transform: translateY(10px); 
            }
        }
        
        .animate-fade-out {
            animation: fadeOut 0.3s ease-out;
        }

        /* Mapa */
        .map-container {
            width: 100%;
            height: 320px;
            border-radius: 12px;
            overflow: hidden;
            opacity: 0;
            transition: opacity 0.3s ease;
            display: none; /* Inicialmente escondido */
            flex-shrink: 0; /* Impede que o mapa redimensione */
        }

        .map-container.visible {
            opacity: 1;
            display: block; /* Mostrar quando vis√≠vel */
        }

        .map-container.hidden {
            opacity: 0;
            display: none; /* Esconder quando oculto */
        }

        /* √Årea principal de chat com scroll */
        .chat-main {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 1rem;
            display: flex;
            flex-direction: column;
        }

        /* Container de mensagens */
        .messages-container {
            flex: 1;
            min-height: min-content;
        }

        /* Classes utilit√°rias */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        /* Corrigir emojis */
        .emoji-fix {
            font-family: "Segoe UI Emoji", "Apple Color Emoji", "Noto Color Emoji", sans-serif;
        }

        /* Reset de estilos para texto */
        * {
            box-sizing: border-box;
        }

        /* Garantir que o footer fique no lugar */
        .footer-fixed {
            flex-shrink: 0;
            background: white;
        }

        /* Scroll suave para a √°rea de chat */
        .smooth-scroll {
            scroll-behavior: smooth;
        }

        /* Bot√£o para ocultar mapa */
        .hide-map-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 6px 12px;
            font-size: 12px;
            font-weight: 500;
            color: #374151;
            cursor: pointer;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .hide-map-btn:hover {
            background: white;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transform: translateY(-1px);
        }

        .hide-map-btn:active {
            transform: translateY(0);
        }

        /* Container do mapa com posi√ß√£o relativa */
        .map-wrapper {
            position: relative;
        }
    </style>
</head>
<body>
    <div id="root" role="main" aria-label="Aplicativo de Pr√©-Diagn√≥stico"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- DATASET LOCAL ---
        const DATASET_SINTOMAS = {
            "cabe√ßa": "Cefaleia, enxaqueca ou tens√£o.",
            "febre": "Infec√ß√£o viral ou bacteriana.",
            "tosse": "Alergia, gripe ou bronquite.",
            "peito": "ALERTA: Dor no peito requer urg√™ncia m√©dica imediata.",
            "ar": "ALERTA: Falta de ar √© emerg√™ncia.",
            "barriga": "Gases, gastrite ou c√≥lica.",
            "garganta": "Inflama√ß√£o, faringite ou amigdalite.",
            "pele": "Dermatite, alergia ou infec√ß√£o cut√¢nea.",
            "costas": "Tens√£o muscular, m√° postura ou problema renal."
        };

        // --- √çCONES (Componentes React) ---
        const SendIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" aria-hidden="true">
                <title>Enviar mensagem</title>
                <line x1="22" y1="2" x2="11" y2="13"></line>
                <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
            </svg>
        );
        
        const StethoscopeIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" aria-hidden="true">
                <title>Estetosc√≥pio</title>
                <path d="M4.8 2.3A.3.3 0 1 0 5 2H4a2 2 0 0 0-2 2v5a6 6 0 0 0 6 6v0a6 6 0 0 0 6-6V4a2 2 0 0 0-2-2h-1a.2.2 0 1 0 .3.3"></path>
                <path d="M8 15v1a6 6 0 0 0 6 6v0a6 6 0 0 0-6-6v-4"></path>
                <circle cx="20" cy="10" r="2"></circle>
            </svg>
        );

        const AlertIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#ca8a04" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" aria-hidden="true">
                <title>Alerta</title>
                <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
                <line x1="12" y1="9" x2="12" y2="13"></line>
                <line x1="12" y1="17" x2="12.01" y2="17"></line>
            </svg>
        );

        const HospitalIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" aria-hidden="true">
                <title>Hospital</title>
                <path d="M12 6v4"></path>
                <path d="M14 14h-4"></path>
                <path d="M14 18h-4"></path>
                <path d="M14 8h-4"></path>
                <path d="M18 12h2a2 2 0 0 1 2 2v6a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2v-9a2 2 0 0 1 2-2h2"></path>
                <path d="M18 22V4a2 2 0 0 0-2-2H8a2 2 0 0 0-2 2v18"></path>
            </svg>
        );
        
        const MenuIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" aria-hidden="true">
                <title>Menu</title>
                <line x1="4" y1="12" x2="20" y2="12"></line>
                <line x1="4" y1="6" x2="20" y2="6"></line>
                <line x1="4" y1="18" x2="20" y2="18"></line>
            </svg>
        );

        const MapIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" aria-hidden="true">
                <title>Mapa</title>
                <polygon points="1 6 1 22 8 18 16 22 23 18 23 2 16 6 8 2 1 6"></polygon>
                <line x1="8" y1="2" x2="8" y2="18"></line>
                <line x1="16" y1="6" x2="16" y2="22"></line>
            </svg>
        );

        const EyeOffIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" aria-hidden="true">
                <title>Ocultar</title>
                <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path>
                <line x1="1" y1="1" x2="23" y2="23"></line>
            </svg>
        );

        // --- COMPONENTE: Texto Formatado ---
        const FormattedText = ({ text }) => {
            const lines = text.split('\n');
            
            return (
                <div className="space-y-1 text-sm leading-relaxed text-gray-700">
                    {lines.map((line, i) => {
                        if (!line.trim()) return <br key={i} />;
                        
                        const parts = line.split(/(\*\*.*?\*\*)/g);
                        return (
                            <p key={i}>
                                {parts.map((part, j) => {
                                    if (part.startsWith('**') && part.endsWith('**')) {
                                        return <strong key={j} className="text-teal-900 font-bold">{part.slice(2, -2)}</strong>;
                                    }
                                    return part;
                                })}
                            </p>
                        );
                    })}
                </div>
            );
        };

        // --- FUN√á√ïES AUXILIARES ---
        const checkLocalDataset = (text) => {
            const lowerText = text.toLowerCase();
            let detected = null;
            
            for (const [key, value] of Object.entries(DATASET_SINTOMAS)) {
                if (lowerText.includes(key)) {
                    detected = { keyword: key, desc: value };
                    break;
                }
            }
            return detected;
        };

        const haversineKm = (lat1, lon1, lat2, lon2) => {
            const toRad = (v) => v * Math.PI / 180;
            const R = 6371;
            const dLat = toRad(lat2 - lat1);
            const dLon = toRad(lon2 - lon1);
            const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon/2)**2;
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        };

        // --- COMPONENTE PRINCIPAL ---
        const App = () => {
            const [messages, setMessages] = useState([
                { 
                    id: 1, 
                    sender: 'ai', 
                    text: "Ol√°. Sou o seu assistente virtual de pr√©-diagn√≥stico. Descreva os seus sintomas para que eu possa ajudar.",
                    localAlert: null 
                }
            ]);
            const [inputValue, setInputValue] = useState("");
            const [isLoading, setIsLoading] = useState(false);
            const [userLocation, setUserLocation] = useState(null);
            const [places, setPlaces] = useState([]);
            const [placesLoading, setPlacesLoading] = useState(false);
            const [locationAsked, setLocationAsked] = useState(false);
            const [showMap, setShowMap] = useState(false);
            const [showMapPrompt, setShowMapPrompt] = useState(false);
            const [mapHiding, setMapHiding] = useState(false); // Controla a anima√ß√£o de ocultar
            
            const chatEndRef = useRef(null);
            const textareaRef = useRef(null);
            const mapRefLeaflet = useRef(null);
            const mainContainerRef = useRef(null);

            // Scroll autom√°tico para o final
            const scrollToBottom = () => {
                setTimeout(() => {
                    if (chatEndRef.current) {
                        chatEndRef.current.scrollIntoView({ 
                            behavior: "smooth",
                            block: "end"
                        });
                    }
                }, 100);
            };

            // Scroll quando mensagens mudam ou mapa √© mostrado
            useEffect(() => {
                scrollToBottom();
            }, [messages, showMap, showMapPrompt]);

            // Ajustar altura do textarea
            const handleInput = (e) => {
                setInputValue(e.target.value);
                e.target.style.height = 'auto';
                e.target.style.height = `${Math.min(e.target.scrollHeight, 120)}px`;
            };

            // Obter localiza√ß√£o do usu√°rio
            const getUserLocation = () => new Promise((resolve, reject) => {
                if (!navigator.geolocation) return reject(new Error('Geolocaliza√ß√£o n√£o suportada'));
                if (locationAsked) return reject(new Error('Localiza√ß√£o j√° foi pedida'));
                
                setLocationAsked(true);
                navigator.geolocation.getCurrentPosition(
                    (pos) => resolve({ lat: pos.coords.latitude, lon: pos.coords.longitude }),
                    (err) => reject(err),
                    { enableHighAccuracy: true, timeout: 10000 }
                );
            });

            // Inicializar mapa
            const initMap = (lat, lon) => {
                setShowMap(true);
                setMapHiding(false);
                
                // Delay para garantir que o DOM foi atualizado
                setTimeout(() => {
                    const mapElement = document.getElementById('map');
                    if (!mapElement) {
                        console.error('Elemento do mapa n√£o encontrado');
                        return;
                    }

                    if (mapRefLeaflet.current) {
                        try { 
                            mapRefLeaflet.current.setView([lat, lon], 13); 
                            if (!mapRefLeaflet.current._userMarker) {
                                const userMarker = L.marker([lat, lon])
                                    .addTo(mapRefLeaflet.current)
                                    .bindPopup('Sua localiza√ß√£o')
                                    .openPopup();
                                mapRefLeaflet.current._userMarker = userMarker;
                            }
                            
                            // For√ßar redimensionamento ap√≥s atualiza√ß√£o
                            setTimeout(() => { 
                                try { 
                                    mapRefLeaflet.current.invalidateSize(); 
                                } catch(e){} 
                            }, 300);
                        } catch(e){
                            console.error('Erro ao atualizar mapa:', e);
                        }
                        return;
                    }
                    
                    try {
                        const map = L.map('map', { 
                            preferCanvas: true,
                            zoomControl: true,
                            renderer: L.canvas()
                        }).setView([lat, lon], 13);
                        
                        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                            maxZoom: 19,
                            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
                        }).addTo(map);
                        
                        const userMarker = L.marker([lat, lon])
                            .addTo(map)
                            .bindPopup('Sua localiza√ß√£o')
                            .openPopup();
                        map._userMarker = userMarker;
                        
                        mapRefLeaflet.current = map;
                        
                        // Redimensionar ap√≥s o mapa ser completamente renderizado
                        setTimeout(() => { 
                            try { 
                                map.invalidateSize(); 
                            } catch(e) {
                                console.error('Erro ao ajustar tamanho do mapa:', e);
                            }
                        }, 400);
                        
                    } catch(e) {
                        console.error('Erro ao criar mapa:', e);
                    }
                }, 150);
            };

            // Fun√ß√£o para ocultar o mapa
            const handleHideMap = () => {
                setMapHiding(true);
                
                // Aguardar anima√ß√£o de fade out
                setTimeout(() => {
                    setShowMap(false);
                    setMapHiding(false);
                    
                    // Adicionar mensagem confirmando que o mapa foi ocultado
                    const mapaOcultadoMsg = {
                        id: Date.now() + 2000,
                        sender: 'ai',
                        text: 'Mapa ocultado. Se quiser ver novamente os locais m√©dicos, √© s√≥ pedir!',
                        localAlert: null
                    };
                    setMessages(prev => [...prev, mapaOcultadoMsg]);
                }, 300); // Tempo da anima√ß√£o
            };

            // Buscar locais m√©dicos via backend
            const fetchNearbyPlaces = async (lat, lon, radius = 5000) => {
                setPlacesLoading(true);
                try {
                    const response = await fetch('http://localhost:3000/api/locais-proximos', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ lat, lon, radius })
                    });

                    const data = await response.json();
                    
                    if (!data.success) {
                        console.error('Erro ao buscar locais:', data.error);
                        return [];
                    }

                    const processedPlaces = (data.lugares || []).map(el => {
                        const latEl = el.lat || (el.center && el.center.lat);
                        const lonEl = el.lon || (el.center && el.center.lon);
                        
                        return {
                            id: el.id,
                            name: (el.tags && el.tags.name) || 'Sem nome',
                            amenity: (el.tags && el.tags.amenity) || 'local',
                            lat: latEl,
                            lon: lonEl,
                            distanceKm: latEl ? haversineKm(lat, lon, latEl, lonEl) : Infinity,
                            tags: el.tags || {}
                        };
                    }).filter(r => r.lat && r.lon)
                      .sort((a, b) => a.distanceKm - b.distanceKm)
                      .slice(0, 15);

                    setPlaces(processedPlaces);

                    if (!mapRefLeaflet.current) {
                        initMap(lat, lon);
                    }
                    
                    // Aguardar mapa estar pronto
                    setTimeout(() => {
                        if (!mapRefLeaflet.current) return;
                        
                        if (mapRefLeaflet.current._placesLayer) {
                            mapRefLeaflet.current.removeLayer(mapRefLeaflet.current._placesLayer);
                        }
                        
                        const markers = L.layerGroup();
                        processedPlaces.forEach(p => {
                            const color = p.amenity === 'hospital' ? '#e11d48' : 
                                         p.amenity === 'pharmacy' ? '#059669' : '#0ea5e9';
                            
                            const marker = L.circleMarker([p.lat, p.lon], {
                                radius: 8,
                                fillColor: color,
                                color: '#fff',
                                weight: 1,
                                fillOpacity: 0.9
                            });
                            
                            const popupHtml = `
                                <div class="p-2">
                                    <strong class="text-sm">${p.name}</strong><br/>
                                    <em class="text-xs">${p.amenity}</em><br/>
                                    <span class="text-xs">${p.distanceKm.toFixed(2)} km</span><br/>
                                    <a href="https://www.openstreetmap.org/?mlat=${p.lat}&mlon=${p.lon}#map=18/${p.lat}/${p.lon}" 
                                       target="_blank" 
                                       rel="noopener noreferrer"
                                       class="text-xs text-blue-600 hover:underline">
                                       Abrir no mapa
                                    </a>
                                </div>
                            `;
                            
                            marker.bindPopup(popupHtml);
                            marker.addTo(markers);
                        });
                        
                        markers.addTo(mapRefLeaflet.current);
                        mapRefLeaflet.current._placesLayer = markers;
                        
                        // Redimensionar mapa ap√≥s adicionar marcadores
                        setTimeout(() => { 
                            try { 
                                mapRefLeaflet.current.invalidateSize(); 
                            } catch(e) {
                                console.error('Erro ao ajustar mapa:', e);
                            }
                        }, 300);

                    }, 600);

                    return processedPlaces;
                    
                } catch (err) {
                    console.error('Erro ao buscar locais:', err);
                    return [];
                } finally {
                    setPlacesLoading(false);
                }
            };

            // NOVA FUN√á√ÉO: Mostrar mapa quando usu√°rio clicar no bot√£o
            const handleShowMap = async () => {
                try {
                    setShowMapPrompt(false); // Esconde o prompt
                    
                    let coords;
                    
                    if (userLocation) {
                        coords = userLocation;
                    } else {
                        coords = await getUserLocation();
                        setUserLocation(coords);
                    }
                    
                    // Inicializar mapa
                    initMap(coords.lat, coords.lon);
                    
                    // Buscar locais m√©dicos
                    const lugaresEncontrados = await fetchNearbyPlaces(coords.lat, coords.lon);
                    
                    if (lugaresEncontrados.length > 0) {
                        const topLugares = lugaresEncontrados.slice(0, 5);
                        const listaLugares = topLugares.map((p, i) => 
                            `${i+1}. ${p.name} ‚Äî ${p.distanceKm.toFixed(2)} km`
                        ).join('\n');
                        
                        const lugaresMsg = {
                            id: Date.now() + 1000,
                            sender: 'ai',
                            text: `Encontrei ${lugaresEncontrados.length} locais m√©dicos pr√≥ximos:\n\n${listaLugares}\n\nConsulte o mapa abaixo para mais detalhes.`,
                            localAlert: null
                        };
                        setMessages(prev => [...prev, lugaresMsg]);
                    }
                    
                } catch (geoErr) {
                    console.warn('Erro de geolocaliza√ß√£o:', geoErr);
                    
                    const erroGeoMsg = {
                        id: Date.now() + 1001,
                        sender: 'ai',
                        text: 'Para mostrar locais m√©dicos pr√≥ximos, √© necess√°rio permitir a geolocaliza√ß√£o no seu navegador.',
                        localAlert: null
                    };
                    setMessages(prev => [...prev, erroGeoMsg]);
                }
            };

            // NOVA FUN√á√ÉO: N√£o mostrar mapa
            const handleDontShowMap = () => {
                setShowMapPrompt(false);
                const mensagemObrigado = {
                    id: Date.now() + 1002,
                    sender: 'ai',
                    text: 'Sem problemas. Se precisar de locais m√©dicos mais tarde, √© s√≥ perguntar!',
                    localAlert: null
                };
                setMessages(prev => [...prev, mensagemObrigado]);
            };

            // Pedir localiza√ß√£o ao carregar a p√°gina
            useEffect(() => {
                getUserLocation()
                    .then(coords => {
                        setUserLocation(coords);
                    })
                    .catch(err => {
                        console.warn('Geolocaliza√ß√£o n√£o dispon√≠vel:', err.message);
                    });
            }, []);

            // Fun√ß√£o principal para enviar mensagem
            const handleSend = async () => {
                if (!inputValue.trim() || isLoading) return;

                const userText = inputValue;
                setInputValue("");
                
                if (textareaRef.current) {
                    textareaRef.current.style.height = 'auto';
                }

                const localMatch = checkLocalDataset(userText);

                const userMsg = { 
                    id: Date.now(), 
                    sender: 'user', 
                    text: userText,
                    localAlert: null 
                };
                setMessages(prev => [...prev, userMsg]);
                setIsLoading(true);

                try {
                    const response = await fetch('http://localhost:3000/api/chat-medico', {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        },
                        body: JSON.stringify({
                            sintomas: userText,
                            idade: null,
                            historico: null
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const data = await response.json();
                    
                    let aiText = "Desculpe, n√£o consegui processar seu pedido.";
                    
                    if (data.success) {
                        aiText = data.resposta;
                    } else {
                        aiText = `Erro: ${data.error}`;
                    }

                    const aiMsg = {
                        id: Date.now() + 1,
                        sender: 'ai',
                        text: aiText,
                        localAlert: localMatch
                    };
                    setMessages(prev => [...prev, aiMsg]);

                    // NOVO: Mostrar prompt para ver mapa ap√≥s o diagn√≥stico
                    setTimeout(() => {
                        setShowMapPrompt(true);
                    }, 500);

                } catch (error) {
                    console.error('Erro geral:', error);
                    
                    let errorMessage = "Erro de conex√£o com o servidor. Tente novamente mais tarde.";
                    
                    if (error.message.includes('Failed to fetch')) {
                        errorMessage = "N√£o foi poss√≠vel conectar ao servidor. Verifique se o backend est√° rodando.";
                    } else if (error.message.includes('NetworkError')) {
                        errorMessage = "Erro de rede. Verifique sua conex√£o com a internet.";
                    }
                    
                    const erroMsg = {
                        id: Date.now() + 1,
                        sender: 'ai',
                        text: errorMessage,
                        localAlert: null
                    };
                    setMessages(prev => [...prev, erroMsg]);
                    
                } finally {
                    setIsLoading(false);
                }
            };

            // Handler para tecla Enter
            const handleKeyDown = (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    handleSend();
                }
            };

            // Centro mapa em local espec√≠fico
            const centerMapOnPlace = (lat, lon) => {
                if (mapRefLeaflet.current) {
                    mapRefLeaflet.current.setView([lat, lon], 16);
                    setTimeout(() => {
                        try { 
                            mapRefLeaflet.current.invalidateSize(); 
                        } catch(e) {
                            console.error('Erro ao centralizar mapa:', e);
                        }
                    }, 100);
                }
            };

            return (
                <article className="flex flex-col min-h-screen bg-gray-100 h-full">
                    
                    {/* Cabe√ßalho sem√¢ntico - FIXO */}
                    <header className="bg-teal-700 text-white p-4 shadow-lg z-10 flex-shrink-0">
                        <div className="w-full flex items-center justify-between px-4 md:px-8">
                            
                            <div className="flex items-center gap-3">
                                <figure className="bg-white/10 p-2 rounded-full">
                                    <StethoscopeIcon />
                                    <figcaption className="sr-only">Logo do Sistema</figcaption>
                                </figure>
                                
                                <div>
                                    <h1 className="font-bold text-lg leading-tight">Sistema Inteligente de Pr√©-Diagn√≥stico</h1>
                                    <p className="text-teal-200 text-xs font-medium tracking-wide">
                                        Assistente M√©dico Virtual & Encaminhamento
                                    </p>
                                </div>
                            </div>
                            
                            <div className="flex items-center gap-4">
                                <div className="text-right hidden sm:block">
                                    <div className="text-xs text-teal-200 emoji-fix">
                                        {userLocation ? (
                                            <span className="flex items-center gap-1">
                                                <span role="img" aria-label="Localiza√ß√£o dispon√≠vel">üìç</span>
                                                Localiza√ß√£o dispon√≠vel
                                            </span>
                                        ) : (
                                            <span className="flex items-center gap-1">
                                                <span role="img" aria-label="Aguardando localiza√ß√£o">üåê</span>
                                                Aguardando localiza√ß√£o
                                            </span>
                                        )}
                                    </div>
                                </div>

                                <button 
                                    className="text-white hover:text-teal-200 transition-colors p-1 rounded-full"
                                    title="Menu"
                                    aria-label="Abrir menu"
                                >
                                    <MenuIcon />
                                </button>
                            </div>
                        </div>
                    </header>

                    {/* √Årea principal com scroll - CORRIGIDA */}
                    <main ref={mainContainerRef} className="flex-1 overflow-y-auto smooth-scroll">
                        <div className="max-w-6xl mx-auto p-4">
                            <section aria-label="Conversa de diagn√≥stico" className="messages-container">
                                {messages.map((msg) => (
                                    <article 
                                        key={msg.id} 
                                        className={`flex flex-col ${msg.sender === 'user' ? 'items-end' : 'items-start'} animate-fade-in mb-4`}
                                        aria-live={msg.sender === 'ai' ? "polite" : "off"}
                                    >
                                        
                                        {msg.sender === 'ai' && msg.localAlert && (
                                            <aside className="mb-2 bg-yellow-50 border border-yellow-200 text-yellow-800 text-xs px-3 py-2 rounded-lg flex items-center gap-2 shadow-sm max-w-[85%] md:max-w-[70%]"
                                                   role="alert"
                                                   aria-label="Alerta do sistema">
                                                <AlertIcon />
                                                <span>
                                                    <strong className="font-semibold">Sistema identificou:</strong> 
                                                    {msg.localAlert.keyword.toUpperCase()} - {msg.localAlert.desc}
                                                </span>
                                            </aside>
                                        )}

                                        <div className={`
                                            relative px-5 py-3 rounded-2xl text-base shadow-sm max-w-[85%] md:max-w-[70%]
                                            ${msg.sender === 'user' 
                                                ? 'bg-teal-600 text-white rounded-br-none' 
                                                : 'bg-white text-gray-800 rounded-bl-none border border-gray-100'}
                                        `}>
                                            {msg.sender === 'ai' ? (
                                                <FormattedText text={msg.text} />
                                            ) : (
                                                <p className="whitespace-pre-wrap">{msg.text}</p>
                                            )}
                                        </div>
                                        
                                        <time className="text-[10px] text-gray-400 mt-1 px-1" dateTime={new Date().toISOString()}>
                                            {msg.sender === 'user' ? 'Voc√™' : 'Assistente M√©dico'} ‚Ä¢ 
                                            {new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
                                        </time>
                                    </article>
                                ))}

                                {/* Prompt para mostrar mapa - NOVO */}
                                {showMapPrompt && !showMap && (
                                    <article className="flex items-start animate-fade-in mb-4" aria-live="polite">
                                        <div className="bg-white px-5 py-4 rounded-2xl rounded-bl-none border border-gray-100 shadow-sm max-w-[85%] md:max-w-[70%]">
                                            <div className="flex items-center gap-2 mb-3">
                                                <MapIcon />
                                                <h3 className="font-semibold text-gray-800">Gostaria de ver locais m√©dicos pr√≥ximos?</h3>
                                            </div>
                                            <p className="text-sm text-gray-600 mb-4">
                                                Posso mostrar hospitais, cl√≠nicas e farm√°cias pr√≥ximas da sua localiza√ß√£o.
                                            </p>
                                            <div className="flex flex-wrap gap-2">
                                                <button 
                                                    onClick={handleShowMap}
                                                    className="bg-teal-600 hover:bg-teal-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors flex items-center gap-2"
                                                    aria-label="Sim, mostrar mapa com locais m√©dicos"
                                                >
                                                    <span role="img" aria-hidden="true">üìç</span>
                                                    Sim, mostrar mapa
                                                </button>
                                                <button 
                                                    onClick={handleDontShowMap}
                                                    className="bg-gray-200 hover:bg-gray-300 text-gray-800 px-4 py-2 rounded-lg text-sm font-medium transition-colors"
                                                    aria-label="N√£o mostrar mapa"
                                                >
                                                    N√£o, obrigado
                                                </button>
                                            </div>
                                        </div>
                                    </article>
                                )}

                                {/* Indicador de carregamento */}
                                {isLoading && (
                                    <article className="flex items-start animate-fade-in mb-4" aria-live="polite">
                                        <div className="bg-white px-4 py-3 rounded-2xl rounded-bl-none border border-gray-100 shadow-sm flex items-center gap-1"
                                             role="status"
                                             aria-label="Processando resposta">
                                            <div className="w-2 h-2 bg-teal-500 rounded-full typing-dot"></div>
                                            <div className="w-2 h-2 bg-teal-500 rounded-full typing-dot"></div>
                                            <div className="w-2 h-2 bg-teal-500 rounded-full typing-dot"></div>
                                            <span className="text-xs text-gray-500 ml-2">Processando...</span>
                                        </div>
                                    </article>
                                )}
                            </section>
                            
                            {/* Se√ß√£o do Mapa e Locais Pr√≥ximos - S√≥ aparece quando showMap √© true */}
                            {showMap && (
                                <section aria-labelledby="locais-proximos-titulo" className={`space-y-4 mt-6 mb-6 ${mapHiding ? 'animate-fade-out' : 'animate-fade-in'}`}>
                                    <header className="flex items-center justify-between">
                                        <h2 id="locais-proximos-titulo" className="text-sm font-semibold text-gray-700 flex items-center gap-2">
                                            <HospitalIcon /> Locais m√©dicos pr√≥ximos
                                        </h2>
                                        <span className="text-xs text-gray-500">
                                            {placesLoading ? 'Buscando...' : `${places.length} locais encontrados`}
                                        </span>
                                    </header>
                                    
                                    <div className="map-wrapper relative">
                                        {/* Bot√£o para ocultar mapa */}
                                        <button 
                                            onClick={handleHideMap}
                                            className="hide-map-btn"
                                            aria-label="Ocultar mapa"
                                            title="Ocultar mapa"
                                        >
                                            <EyeOffIcon />
                                            Ocultar mapa
                                        </button>
                                        
                                        <figure className={`map-container ${mapHiding ? 'hidden' : 'visible'} shadow-lg rounded-xl overflow-hidden border border-gray-200`}>
                                            <div id="map" className="h-full w-full"></div>
                                            <figcaption className="sr-only">
                                                Mapa mostrando locais m√©dicos pr√≥ximos √† sua localiza√ß√£o
                                            </figcaption>
                                        </figure>
                                    </div>

                                    {places.length > 0 && (
                                        <div className="bg-white p-4 rounded-xl border border-gray-100 shadow-sm">
                                            <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                                                {places.slice(0, 8).map(p => (
                                                    <article key={p.id} className="flex items-center justify-between p-3 border border-gray-100 rounded-lg hover:bg-gray-50 transition-colors">
                                                        <div className="flex-1">
                                                            <h3 className="font-medium text-sm text-gray-800">{p.name}</h3>
                                                            <div className="flex items-center gap-2 mt-1">
                                                                <span className={`text-xs px-2 py-0.5 rounded-full ${
                                                                    p.amenity === 'hospital' ? 'bg-red-100 text-red-800' :
                                                                    p.amenity === 'pharmacy' ? 'bg-green-100 text-green-800' :
                                                                    'bg-blue-100 text-blue-800'
                                                                }`}>
                                                                    {p.amenity}
                                                                </span>
                                                                <span className="text-xs text-gray-500">{p.distanceKm.toFixed(1)} km</span>
                                                            </div>
                                                        </div>
                                                        <button 
                                                            onClick={() => centerMapOnPlace(p.lat, p.lon)}
                                                            className="text-xs text-teal-600 hover:text-teal-800 font-medium hover:underline ml-2"
                                                            aria-label={`Centralizar mapa em ${p.name}`}
                                                        >
                                                            Ver no mapa
                                                        </button>
                                                    </article>
                                                ))}
                                            </div>
                                        </div>
                                    )}
                                </section>
                            )}

                            <div ref={chatEndRef} aria-hidden="true" />
                        </div>
                    </main>

                    {/* Rodap√© com √°rea de input - FIXO */}
                    <footer className="footer-fixed border-t border-gray-200 shadow-inner">
                        <div className="max-w-6xl mx-auto p-4">
                            <form onSubmit={(e) => { e.preventDefault(); handleSend(); }} className="space-y-3">
                                <div className="relative flex items-end gap-2 bg-gray-50 border border-gray-300 rounded-xl p-2 focus-within:ring-2 focus-within:ring-teal-500 focus-within:border-teal-500 transition-all">
                                    <label htmlFor="sintomas-input" className="sr-only">
                                        Descreva seus sintomas
                                    </label>
                                    
                                    <textarea
                                        id="sintomas-input"
                                        ref={textareaRef}
                                        value={inputValue}
                                        onChange={handleInput}
                                        onKeyDown={handleKeyDown}
                                        placeholder="Descreva seus sintomas (ex: dor de cabe√ßa, febre, tosse)..."
                                        className="w-full bg-transparent border-none focus:ring-0 resize-none text-gray-700 max-h-32 py-2 px-2 scrollbar-hide placeholder:text-gray-400"
                                        rows={1}
                                        disabled={isLoading}
                                        aria-describedby="input-help-text"
                                        required
                                    ></textarea>
                                    
                                    <button 
                                        type="submit"
                                        disabled={isLoading || !inputValue.trim()}
                                        className={`p-3 rounded-xl transition-all flex-shrink-0 ${
                                            isLoading || !inputValue.trim() 
                                                ? 'bg-gray-200 text-gray-400 cursor-not-allowed' 
                                                : 'bg-teal-600 text-white hover:bg-teal-700 shadow-md hover:shadow-lg active:scale-95'
                                        }`}
                                        title="Enviar mensagem"
                                        aria-label="Enviar mensagem"
                                    >
                                        <SendIcon />
                                    </button>
                                </div>
                                
                                <div id="input-help-text" className="text-center space-y-2">
                                    <p className="text-[11px] text-gray-500 emoji-fix">
                                        üí° <strong>Dica:</strong> Seja espec√≠fico nos sintomas (ex: "dor de cabe√ßa intensa h√° 2 dias com n√°useas")
                                    </p>
                                    <p className="text-[11px] text-gray-500 emoji-fix">
                                        ‚ö†Ô∏è <strong>Aviso:</strong> Este sistema √© um assistente virtual e n√£o substitui consulta m√©dica. Em emerg√™ncias, ligue 112.
                                    </p>
                                </div>
                            </form>
                            
                            <address className="text-center mt-3 not-italic">
                                <p className="text-[10px] text-gray-400">
                                    Sistema de Pr√©-Diagn√≥stico ‚Ä¢ v1.0 ‚Ä¢ Backend: http://localhost:3000
                                </p>
                            </address>
                        </div>
                    </footer>
                </article>
            );
        };

        // Inicializar React
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
        
        // Inicializar √≠cones Lucide
        if (window.lucide && window.lucide.createIcons) {
            lucide.createIcons();
        }
    </script>
    
    <!-- Script para verificar conex√£o com servidor -->
    <script>
        window.addEventListener('DOMContentLoaded', async () => {
            try {
                console.log('üîç Verificando conex√£o com servidor...');
                const response = await fetch('http://localhost:3000/api/health', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('‚úÖ Servidor online:', data);
                
                const statusElement = document.createElement('div');
                statusElement.id = 'server-status';
                statusElement.setAttribute('role', 'status');
                statusElement.setAttribute('aria-live', 'polite');
                statusElement.style.cssText = 'position:fixed;top:10px;right:10px;background:#10b981;color:white;padding:8px 12px;border-radius:6px;font-size:12px;z-index:9999;';
                statusElement.textContent = '‚úÖ Servidor conectado';
                document.body.appendChild(statusElement);
                
                setTimeout(() => {
                    statusElement.style.opacity = '0';
                    setTimeout(() => statusElement.remove(), 500);
                }, 5000);
                
            } catch (error) {
                console.error('‚ùå Servidor offline ou erro de conex√£o:', error);
                
                const warningElement = document.createElement('div');
                warningElement.id = 'server-warning';
                warningElement.setAttribute('role', 'alert');
                warningElement.setAttribute('aria-live', 'assertive');
                warningElement.style.cssText = 'position:fixed;top:10px;right:10px;background:#ef4444;color:white;padding:12px 16px;border-radius:6px;font-size:13px;z-index:9999;max-width:300px;box-shadow:0 4px 6px rgba(0,0,0,0.1);';
                warningElement.innerHTML = `
                    <strong>‚ö†Ô∏è Servidor desconectado</strong><br>
                    <small>Certifique-se que executou no terminal:</small><br>
                    <code style="background:rgba(0,0,0,0.2);padding:2px 4px;border-radius:3px;margin-top:4px;display:inline-block;">
                        cd BackEnd<br>npm run dev
                    </code>
                    <button onclick="this.parentElement.remove()" 
                            aria-label="Fechar alerta"
                            style="position:absolute;top:4px;right:8px;background:none;border:none;color:white;cursor:pointer;font-size:16px;">√ó</button>
                `;
                document.body.appendChild(warningElement);
            }
        });
    </script>
</body>
</html>